---
import PageLayout from '@/layouts/PageLayout.astro';
import Container from '@/components/astro/Container.astro';
import CardGrid from '@/components/astro/CardGrid.astro';
import { fetchAPI } from '@/lib/datocms';
import { sanitizeHtml } from '@/lib/sanitize';
import { CASE_STUDY, RECENT_WORK } from '@/graphql/work';

export async function getStaticPaths() {
  const data = await fetchAPI(RECENT_WORK);
  return (data?.allProjects ?? []).map((project: any) => ({
    params: { slug: project.slug },
  }));
}

const { slug } = Astro.params;
const data = await fetchAPI(CASE_STUDY, { variables: { slug } });

if (!data?.project?.slug) {
  return Astro.redirect('/404');
}

const project = data.project;
const moreProjects = data.allProjects ?? [];
---

<PageLayout title={project.title}>
  <Container>
    <div class="w-full max-w-2xl mx-auto">
      <h1
        class="font-display text-3xl md:text-4xl lg:text-5xl tracking-tight mt-8 leading-tight"
        data-animate
        transition:name={`card-${slug}`}
      >
        {project.title}
      </h1>

      <div class="content" set:html={sanitizeHtml(project.caseStudy ?? '')} />

      <hr class="gradient-line mt-16 mb-12" />

      {project.link && (
        <a
          href={project.link}
          rel="noopener noreferrer"
          target="_blank"
          class="inline-flex items-center gap-2 font-body font-semibold text-[var(--accent)] hover:text-[var(--accent-hover)] transition-colors"
        >
          <span>Visit Project</span>
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width={2}
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
            />
          </svg>
        </a>
      )}

      {moreProjects.length > 0 && (
        <div class="mt-20">
          <div class="flex items-center gap-4 mb-8">
            <h3 class="text-sm uppercase font-body font-semibold tracking-widest text-[var(--text-muted)]">
              More projects
            </h3>
            <span class="flex-1 h-[1px] bg-[var(--border)]"></span>
          </div>
          <CardGrid
            items={moreProjects}
            type="project"
            columns={moreProjects.length < 3 ? 2 : 3}
          />
        </div>
      )}

      <div class="my-24 md:my-32" data-animate>
        <h2 class="font-display text-2xl md:text-3xl tracking-tight leading-snug">
          Have a similar project in mind?{' '}
          <a href={`/contact?ref=${slug}`} class="gradient-text hover:opacity-80 transition-opacity">
            Let's chat!
          </a>
        </h2>
      </div>
    </div>
  </Container>
</PageLayout>
