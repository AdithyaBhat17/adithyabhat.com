---
import PageLayout from '@/layouts/PageLayout.astro';
import Container from '@/components/astro/Container.astro';
import CardGrid from '@/components/astro/CardGrid.astro';
import { fetchAPI } from '@/lib/datocms';
import { ALL_ARTICLES_QUERY, ARTICLE_QUERY } from '@/graphql/posts';
import { marked } from 'marked';
import dayjs from 'dayjs';

export async function getStaticPaths() {
  const data = await fetchAPI(ALL_ARTICLES_QUERY);
  return (data?.allArticles ?? []).map((article: any) => ({
    params: { slug: article.slug },
  }));
}

const { slug } = Astro.params;
const data = await fetchAPI(ARTICLE_QUERY, { variables: { slug } });

if (!data?.article?.slug) {
  return Astro.redirect('/404');
}

const article = data.article;
const moreArticles = data.moreArticles ?? [];

// Process markdown to HTML
const htmlContent = await marked(article.content ?? '');
---

<PageLayout title={article.title}>
  <Container>
    <article class="w-full max-w-2xl mx-auto">
      <div class="mt-8 mb-10">
        <small class="font-body text-[var(--text-muted)] text-sm" data-animate>
          {dayjs(article.date).format('DD MMM, YYYY')}
        </small>
        <h1
          class="font-display text-3xl md:text-4xl lg:text-5xl tracking-tight mt-3 leading-tight"
          data-animate
          transition:name={`card-${slug}`}
        >
          {article.title}
        </h1>
      </div>

      <div class="content" set:html={htmlContent} />
    </article>

    {moreArticles.length > 0 && (
      <div class="max-w-4xl mx-auto mt-20">
        <div class="flex items-center gap-4 mb-8">
          <h3 class="text-sm uppercase font-body font-semibold tracking-widest text-[var(--text-muted)]">
            More articles
          </h3>
          <span class="flex-1 h-[1px] bg-[var(--border)]"></span>
        </div>
        <CardGrid items={moreArticles} type="article" />
      </div>
    )}
  </Container>
</PageLayout>
