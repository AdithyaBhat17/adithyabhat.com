---
import PageLayout from '@/layouts/PageLayout.astro';
import Container from '@/components/astro/Container.astro';
import CardGrid from '@/components/astro/CardGrid.astro';
import { fetchAPI } from '@/lib/datocms';
import { ALL_ARTICLES_QUERY, ARTICLE_QUERY } from '@/graphql/posts';
import { marked } from 'marked';
import { sanitizeHtml } from '@/lib/sanitize';
import dayjs from 'dayjs';

export async function getStaticPaths() {
  const data = await fetchAPI(ALL_ARTICLES_QUERY);
  return (data?.allArticles ?? []).map((article: any) => ({
    params: { slug: article.slug },
  }));
}

const { slug } = Astro.params;
const data = await fetchAPI(ARTICLE_QUERY, { variables: { slug } });

if (!data?.article?.slug) {
  return Astro.redirect('/404');
}

const article = data.article;
const moreArticles = data.moreArticles ?? [];

const htmlContent = sanitizeHtml(await marked(article.content ?? ''));

// Reading time estimate
const wordCount = (article.content ?? '').split(/\s+/).filter(Boolean).length;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Parse tags
const tagList = article.tags
  ? article.tags.split(/[,Â·]/).map((t: string) => t.trim()).filter(Boolean)
  : [];

const formattedDate = dayjs(article.date).format('DD MMM, YYYY');
---

<PageLayout title={`${article.title} | Blog`}>
  <!-- Reading progress bar -->
  <div class="reading-progress" aria-hidden="true">
    <div class="reading-progress-bar"></div>
  </div>

  <Container>
    <article class="article-page">
      <!-- Back link -->
      <a href="/blog" class="back-link" data-animate>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12" />
          <polyline points="12 19 5 12 12 5" />
        </svg>
        Back to blog
      </a>

      <!-- Hero area -->
      <header class="article-header" data-animate>
        <h1 class="article-title" transition:name={`card-${slug}`}>
          {article.title}
        </h1>

        <div class="article-meta">
          <time class="article-meta-item" datetime={article.date}>
            {formattedDate}
          </time>
          <span class="article-meta-dot">&middot;</span>
          <span class="article-meta-item">{readingTime} min read</span>
          {tagList.length > 0 && (
            <>
              <span class="article-meta-dot">&middot;</span>
              <div class="article-meta-tags">
                {tagList.map((tag: string) => (
                  <span class="article-meta-tag">{tag}</span>
                ))}
              </div>
            </>
          )}
        </div>
      </header>

      <!-- Hero image -->
      {article.thumbnail?.responsiveImage && (
        <div class="article-hero-img" data-animate>
          <img
            src={article.thumbnail.responsiveImage.src}
            srcset={article.thumbnail.responsiveImage.srcSet}
            sizes={article.thumbnail.responsiveImage.sizes}
            width={article.thumbnail.responsiveImage.width}
            height={article.thumbnail.responsiveImage.height}
            alt={article.thumbnail.responsiveImage.alt || article.title}
            loading="eager"
            decoding="async"
            class="w-full h-full object-cover"
            style={article.thumbnail.responsiveImage.base64 ? `background-image: url(${article.thumbnail.responsiveImage.base64}); background-size: cover;` : ''}
          />
        </div>
      )}

      <!-- Content -->
      <div class="article-body">
        <div class="content" set:html={htmlContent} />
      </div>
    </article>

    <!-- More articles -->
    {moreArticles.length > 0 && (
      <div class="max-w-4xl mx-auto mt-20">
        <div class="flex items-center gap-4 mb-8">
          <h3 class="text-sm uppercase font-body font-semibold tracking-widest text-[var(--text-muted)]">
            More articles
          </h3>
          <span class="flex-1 h-[1px] bg-[var(--border)]"></span>
        </div>
        <CardGrid items={moreArticles} type="article" />
      </div>
    )}
  </Container>

  <style>
    /* ===== Reading progress bar ===== */
    .reading-progress {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      z-index: 100;
      background: transparent;
    }

    .reading-progress-bar {
      height: 100%;
      width: 0%;
      background: var(--gradient-accent);
      transition: width 0.1s linear;
      border-radius: 0 2px 2px 0;
    }

    /* ===== Article layout ===== */
    .article-page {
      width: 100%;
    }

    /* Back link */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      padding: 0.5rem 0;
      margin-top: 1rem;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
    }

    .back-link svg {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .back-link:hover {
      color: var(--accent);
    }

    .back-link:hover svg {
      transform: translateX(-4px);
    }

    /* ===== Header ===== */
    .article-header {
      max-width: 42rem;
      margin: 0 auto 2rem;
    }

    .article-title {
      font-family: 'Bricolage Grotesque', Georgia, serif;
      font-size: clamp(2rem, 5vw, 3.25rem);
      font-weight: 800;
      line-height: 1.15;
      letter-spacing: -0.025em;
      color: var(--text);
      margin-bottom: 1.25rem;
    }

    /* Metadata row */
    .article-meta {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .article-meta-item {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .article-meta-dot {
      color: var(--text-muted);
      opacity: 0.4;
    }

    .article-meta-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .article-meta-tag {
      display: inline-block;
      padding: 0.15rem 0.55rem;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--accent);
      background: var(--accent-glow);
      border: 1px solid transparent;
      border-radius: 100px;
      letter-spacing: 0.02em;
    }

    /* ===== Hero image ===== */
    .article-hero-img {
      max-width: 48rem;
      margin: 0 auto 2.5rem;
      border-radius: var(--radius-xl);
      overflow: hidden;
      aspect-ratio: 16/9;
      background: var(--bg-surface);
    }

    .article-hero-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ===== Article body ===== */
    .article-body {
      max-width: 42rem;
      margin: 0 auto;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 767px) {
      .article-header {
        margin-bottom: 1.5rem;
      }

      .article-title {
        font-size: clamp(1.75rem, 7vw, 2.5rem);
        margin-bottom: 1rem;
      }

      .article-meta {
        gap: 0.375rem;
      }

      .article-hero-img {
        margin: 0 -1.5rem 2rem;
        border-radius: var(--radius);
        max-width: calc(100% + 3rem);
      }

      .back-link {
        margin-top: 0.5rem;
        margin-bottom: 1rem;
      }
    }
  </style>

  <script>
    function initReadingProgress() {
      const bar = document.querySelector<HTMLElement>('.reading-progress-bar');
      if (!bar) return;

      const update = () => {
        const article = document.querySelector('.article-page');
        if (!article) return;

        const rect = article.getBoundingClientRect();
        const total = rect.height - window.innerHeight;
        const scrolled = -rect.top;
        const progress = Math.min(100, Math.max(0, (scrolled / total) * 100));
        bar.style.width = `${progress}%`;
      };

      window.addEventListener('scroll', update, { passive: true });
      update();
    }

    initReadingProgress();
    document.addEventListener('astro:after-swap', initReadingProgress);
  </script>
</PageLayout>
